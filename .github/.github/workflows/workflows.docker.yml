name: DevSecOps Pipeline

on:
  push:
    branches:
      - main 
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2  

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1  

      - name: Build and push Docker image
        run: |
          docker build -t your-image:v1 .
          docker push your-image:v1

      - name: Run Trivy scan on the Docker image
        run: trivy image your-image:v1  

      - name: Run OWASP ZAP scan
        run: docker run --rm owasp/zap2docker-stable zap-baseline.py -t http://127.0.0.1:4280 

      - name: Deploy Docker image to Docker Hub
        run: docker push your-image:v1
        
      - name: Send Slack Notification (Success)
        if: success() 
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"The DevSecOps pipeline for DVWA has completed successfully!"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: Send Slack Notification (Failure)
        if: failure()  
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"The DevSecOps pipeline for DVWA has failed!"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
